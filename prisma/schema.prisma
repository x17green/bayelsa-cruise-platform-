// prisma/schema.prisma
// Bayelsa Boat Cruise Booking System - Advanced Seat Management
// Integrated with Supabase Authentication
// Run: npx prisma migrate dev --name init

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output = "./generated/prisma"
}

enum BookingStatus {
  pending
  held
  paid
  confirmed
  cancelled
  refunded
  expired
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
}

enum CheckinStatus {
  not_checked_in
  checked_in
  no_show
}

enum UserRole {
  customer
  operator
  staff
  admin
}

// User table - Synced with Supabase auth.users
// ID must match auth.users(id) from Supabase
model User {
  id                String    @id @db.Uuid
  email             String?   @unique
  phone             String?
  fullName          String?
  role              UserRole  @default(customer)
  profilePictureUrl String?
  isActive          Boolean   @default(true)
  metadata          Json?     @default("{}")
  bookings          Booking[]
  operators         Operator[]
  manifests         Manifest[]
  checkins          Checkin[]
  seatLocks         SeatLock[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("users")
}

model Operator {
  id                String   @id @default(uuid())
  user              User?    @relation(fields: [userId], references: [id])
  userId            String?  @db.Uuid
  organizationName  String?
  contactEmail      String?
  contactPhone      String?
  verified          Boolean  @default(false)
  metadata          Json?    @default("{}")
  vessels           Vessel[]
  bookings          Booking[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Vessel {
  id              String   @id @default(uuid())
  operator        Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  operatorId      String
  name            String
  registrationNo  String?
  capacity        Int
  description     String?
  vesselMetadata  Json?    @default("{}")
  trips           Trip[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Trip {
  id                 String          @id @default(uuid())
  vessel             Vessel          @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  vesselId           String
  title              String
  description        String?
  externalReference  String?
  durationMinutes    Int?
  isRecurring        Boolean         @default(false)
  schedules          TripSchedule[]
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
}

model TripSchedule {
  id             String      @id @default(uuid())
  trip           Trip        @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tripId         String
  startTime      DateTime
  endTime        DateTime
  capacity       Int
  baseCurrency   String      @default("NGN")
  priceTiers     PriceTier[]
  tripSeats      TripSeat[]
  bookings       Booking[]
  manifests      Manifest[]
  seatLocks      SeatLock[]
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([tripId, startTime])
  @@index([startTime])
}

model PriceTier {
  id               String      @id @default(uuid())
  tripSchedule     TripSchedule @relation(fields: [tripScheduleId], references: [id], onDelete: Cascade)
  tripScheduleId   String
  name             String
  description      String?
  amountKobo       BigInt
  capacity         Int?
  position         Int       @default(0)
  bookingItems     BookingItem[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tripSeats TripSeat[]
}

model TripSeat {
  id              String      @id @default(uuid())
  tripSchedule    TripSchedule @relation(fields: [tripScheduleId], references: [id], onDelete: Cascade)
  tripScheduleId  String
  seatLabel       String
  tier            PriceTier?  @relation(fields: [tierId], references: [id], onDelete: SetNull)
  tierId          String?
  isActive        Boolean     @default(true)
  bookingItem     BookingItem?
  seatLocks       SeatLock[]
  createdAt       DateTime    @default(now())

  @@unique([tripScheduleId, seatLabel])
}

model Booking {
  id               String        @id @default(uuid())
  user             User?         @relation(fields: [userId], references: [id])
  userId           String?       @db.Uuid
  tripSchedule     TripSchedule  @relation(fields: [tripScheduleId], references: [id], onDelete: Cascade)
  tripScheduleId   String
  operator         Operator?     @relation(fields: [operatorId], references: [id])
  operatorId       String?
  status           BookingStatus @default(pending)
  totalAmountKobo  BigInt
  currency         String        @default("NGN")
  holdExpiresAt    DateTime?
  metadata         Json?         @default("{}")
  items            BookingItem[]
  payments         Payment[]
  seatLocks        SeatLock[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([userId, status])
}

model BookingItem {
  id             String        @id @default(uuid())
  booking        Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId      String
  priceTier      PriceTier?    @relation(fields: [priceTierId], references: [id], onDelete: SetNull)
  priceTierId    String?
  tripSeat       TripSeat?     @relation(fields: [tripSeatId], references: [id], onDelete: SetNull)
  tripSeatId     String?    @unique
  passengerName  String?
  passengerPhone String?
  ticketReference String?
  status         CheckinStatus @default(not_checked_in)
  checkin        Checkin?
  createdAt      DateTime      @default(now())

  @@index([bookingId])
}

model Payment {
  id                 String        @id @default(uuid())
  booking            Booking?      @relation(fields: [bookingId], references: [id])
  bookingId          String?
  provider           String
  providerPaymentId  String?
  status             PaymentStatus @default(pending)
  amountKobo         BigInt
  currency           String        @default("NGN")
  rawResponse        Json?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([bookingId])
}

model WebhookEvent {
  id                String   @id @default(uuid())
  provider          String
  eventType         String
  providerEventId   String   @unique
  payload           Json
  signature         String?
  receivedAt        DateTime @default(now())
  processed         Boolean  @default(false)
  processedAt       DateTime?
  processingError   String?
}

model Manifest {
  id              String      @id @default(uuid())
  tripSchedule    TripSchedule @relation(fields: [tripScheduleId], references: [id], onDelete: Cascade)
  tripScheduleId  String
  generatedBy     User?       @relation(fields: [generatedById], references: [id])
  generatedById   String?     @db.Uuid
  generatedAt     DateTime    @default(now())
  payload         Json
}

model Checkin {
  id             String       @id @default(uuid())
  bookingItem    BookingItem  @relation(fields: [bookingItemId], references: [id], onDelete: Cascade)
  bookingItemId  String       @unique
  checkedInBy    User?        @relation(fields: [checkedInById], references: [id])
  checkedInById  String?      @db.Uuid
  checkedInAt    DateTime     @default(now())
  method         String       @default("qr")
}

model SeatLock {
  id             String      @id @default(uuid())
  tripSchedule   TripSchedule @relation(fields: [tripScheduleId], references: [id], onDelete: Cascade)
  tripScheduleId String
  tripSeat       TripSeat?    @relation(fields: [tripSeatId], references: [id], onDelete: SetNull)
  tripSeatId     String?
  booking        Booking?     @relation(fields: [bookingId], references: [id])
  bookingId      String?
  lockedBy       User?        @relation(fields: [lockedById], references: [id])
  lockedById     String?      @db.Uuid
  lockedAt       DateTime     @default(now())
  expiresAt      DateTime
  
  @@unique([tripScheduleId, tripSeatId])
  @@index([tripScheduleId])
}
